{% extends 'chat/base.html' %}

{% block content %}
<title>Home</title>
	{% comment %} NAVBAR START {% endcomment %}
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" disabled>ChatScape</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="{% url 'home' %}" style="margin-right:40px;">Home</a>
        </li>
		<li class="nav-item">
          <a class="nav-link active" aria-current="page" href="{% url 'find' %}" style="margin-right:40px;">Find People</a>
        </li>
		<li class="nav-item">
          <a class="btn btn-outline-warning nav-link active" aria-current="page" href="{% url 'chat' %}" style="margin-right:40px;">Chat</a>
        </li>
		<li class="nav-item">
          <a class="nav-link active" aria-current="page" href="{% url 'logout' %}">Logout</a>
        </li>
		
        </ul>
    </div>
  </div>
</nav> 
{% comment %} NAVBAR ENDS HERE {% endcomment %}


<br>

<center>
	<h5> Start Chatscaping!</h5>
	<body>
		
		<div class="card" style="width: 50rem;" >
 			<div class="card-body" id="chat-log" style="max-height: 300px; overflow-y: scroll;">
    			{% for message in old_messages %}<b>{{ message.username }}</b>: {{ message.content }}<br>{% endfor %}
		 	</div>
		</div><br><br><br>
		<div class="container">
		<input id="chat-message-input" type="text" class="form-control">
		</div><br>
    <input id="chat-message-submit" type="button" value="Send as {{username}}" class="btn btn-success">
	{{ username|json_script:"username" }}
	   <script>
	   function goToBottom() {
                let objDiv = document.getElementById("chat-log");
                objDiv.scrollTop = objDiv.scrollHeight;
            }
			goToBottom();
			
	    const userName = JSON.parse(document.getElementById('username').textContent);
		
			const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
        );

		chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
			if (data.message) {
				const author = data.username.replace(/"/g,"")
            	document.querySelector('#chat-log').innerHTML += ('<b>' + author + '</b>: ' + data.message + '<br>');
			}else{
				alert('The message cannot be empty!');
			}
			goToBottom();
        };

		chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

		document.querySelector('#chat-message-input').focus();
		document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) { 
                document.querySelector('#chat-message-submit').click();
            }
        };
		 document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
				'username': userName,
                'message': message
            }));
            messageInputDom.value = '';
        };
		console.log(userName);
		</script> 
		
	</body>
</center>

{% endblock %}